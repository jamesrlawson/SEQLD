{
    "contents" : "source(\"scripts/functions.R\")\n#source(\"scripts/trait_cleaning.R\")\n\nlibrary(plyr)\nlibrary(reshape2)\nlibrary(reshape)\nlibrary(FD)\nlibrary(ggplot2)\nlibrary(missForest)\nlibrary(mice)\nlibrary(SYNCSA)\n\n\nalltraits <- read.csv(\"data/alltraits.csv\", header=T)\nsites <- read.csv(\"data/sites.csv\", header=T)\nvegSurveys <- read.csv(\"data/vegSurveys.csv\", header=T)\nhydro <- read.csv(\"data/raw/hydro_1975-2008.csv\", header=T)\nleaf.narrowness <- read.csv(\"data/traits/leafnarrowness.csv\", header=T)\n\nalltraits <- merge(alltraits, leaf.narrowness, all.x=TRUE)\n\nalltraits$leaf.area <- NULL\n\n#alltraits$flowering.duration <- NULL\n#alltraits$seed.mass <- NULL\n#alltraits$wood.density <- NULL\n\n#alltraits <- na.omit(alltraits)\n\nalltraits$X <- NULL\n\nalltraits <- missing(alltraits)\nalltraits <- subset(alltraits, missing <3) # only keep species with less than 3 NA trait values\nalltraits$missing <- NULL\n\n#blah <- missForest(alltraits[,2:7], maxiter = 100, verbose =TRUE)\n#alltraits <- data.frame(cbind(alltraits[1], as.data.frame(blah[1])))\n#colnames(alltraits) <- c(\"Taxon\", \n#                         \"flowering.duration\",\n#                        \"leaf.area\",\n#                        \"maximum.height\",\n#                        \"seed.mass\",\n#                        \"SLA\",\n#                        \"wood.density\")\n\n# normalise data\n\nalltraits$SLA <- log10(alltraits$SLA)\n#alltraits$leaf.area <- sqrt(alltraits$leaf.area)\nalltraits$seed.mass <- log10(alltraits$seed.mass)\nalltraits$flowering.duration <- sqrt(alltraits$flowering.duration)\nalltraits$maximum.height <- sqrt(alltraits$maximum.height)\n\n\nblah <- mice(alltraits[,2:7])\nalltraits.imputed <- data.frame(cbind(alltraits[1], complete(blah)))\nalltraits <- data.frame(cbind(alltraits.imputed[,1:6], alltraits[\"leaf.narrowness\"],alltraits[\"wood.density\"]))\nalltraits$wood.density <- NULL\nalltraits$wood.density <- alltraits$wood.density.1\nalltraits$wood.density.1 <- NULL\n\n#alltraits <- na.omit(alltraits)\n\n\n# wide > long format\n\nvegSurveys <- melt(vegSurveys, id.vars = c(\"site\", \"transect\", \"transect.area\"))\n\ncolnames(vegSurveys)[4] <- c(\"Taxon\")\ncolnames(vegSurveys)[5] <- c(\"count\")\n\nvegSurveys$Taxon <- as.factor(trim(vegSurveys$Taxon)) # trim white spaces\nlevels(vegSurveys$Taxon) <- capitalise(levels(vegSurveys$Taxon)) # make sure spp names are properly capitalised\n\n# exclude species with less than x occurrences across the dataset\n\nabundance.allsites <- ddply(vegSurveys, .(Taxon), summarise, countSum = sum(count))\nvegSurveys.short <- subset(abundance.allsites, countSum > 5)\nvegSurveys <- vegSurveys[vegSurveys$Taxon %in% vegSurveys.short$Taxon, ]\n\n# convert transect counts -> site avg # per hectare\n\nvegSurveys$perHa <- vegSurveys$count * 10000 / vegSurveys$transect.area\n\nvegSurveys <- ddply(vegSurveys, .(site, Taxon), summarise, avgPerHa = mean(perHa))\n\nvegSurveys_all <- vegSurveys\n\n# find total cover in stems/Ha for each site\n\nvegSurveys.totalcover <- ddply(vegSurveys, .(site), summarise, totalcover = sum(avgPerHa, na.rm=TRUE))\n#vegSurveys.totalcover <- vegSurveys.totalcover[-3,] # don't know why this row appears!\n\nvegSurveys <- merge(vegSurveys, vegSurveys.totalcover)\n\n#vegSurveys <- merge(vegSurveys, alltraits, all.y=TRUE)\nvegSurveys <- merge(vegSurveys, alltraits) \n\nvegSurveys <- vegSurveys[order(vegSurveys$site),]\n\n# get only traits for species which are present in surveys (kind of circular code here, as this is also done for vegSurveys above)\n\nalltraits <- vegSurveys[!duplicated(vegSurveys[,c(\"Taxon\")]),]\nalltraits <- data.frame(cbind(alltraits[\"Taxon\"],alltraits[,5:10]))\n\n\n\n## NEED TO IMPUTE HERE, BUT BE CAREFUL NOT TO IMPUTE MAXHEIGHTS FOR VINES, OR WOOD DENSITY FOR HERBACEOUS SPP.\n\n\n\n#blah <- missForest(alltraits[,2:7], maxiter = 100, verbose =TRUE)\n#alltraits <- data.frame(cbind(alltraits[1], as.data.frame(blah[1])))\n#colnames(alltraits) <- c(\"Taxon\", \n#                         \"flowering.duration\",\n#                         \"leaf.area\",\n#                         \"maximum.height\",\n#                         \"seed.mass\",\n#                         \"SLA\",\n#                         \"wood.density\")\n\n\n\n# find proportion of cover for which trait data is available\n\nvegSurveys.representedcover  <- merge(ddply(vegSurveys, .(site), summarise, representedcover = sum(avgPerHa, na.rm=TRUE)),\n                                      vegSurveys.totalcover)\n\nvegSurveys.representedcover$proportion <- vegSurveys.representedcover$representedcover / vegSurveys.representedcover$totalcover\n\n\nabun <- cast(vegSurveys, site ~ Taxon, value=\"avgPerHa\", fill=0)\n\n\nabun <- abun[order(abun$site),]\n#abun <- abun[-46,] \nabun$site <- NULL\nabun <- data.frame(abun)\n\nTaxon <- alltraits$Taxon \nalltraits$Taxon <- NULL\nrownames(alltraits) <- Taxon # dbFD requires this format\nrm(Taxon)\n\n\n\n\n# calculate FD\n\nFD <- dbFD(alltraits, \n           abun,\n           w.abun = TRUE,  \n           stand.x = TRUE,\n           corr = c(\"cailliez\"),\n           #                calc.FGR = TRUE, \n           #                clust.type = c(\"kmeans\"),\n           #                km.inf.gr = c(2),\n           #                km.sup.gr = c(10),\n           #                km.iter = (100),\n           #                calc.FDiv = TRUE, \n           #                calc.FRic = TRUE,\n           m = \"max\",\n           calc.CWM=TRUE, \n           print.pco=TRUE, \n          #                scale.RaoQ=TRUE, \n          #                stand.FRic=TRUE\n)\n\n\nFD.redun <- rao.diversity(abun, traits=alltraits)\n\n\n\n\n# trait correlations\n\n#cor(alltraits)\n#alltraits.pca <- prcomp(alltraits, center=TRUE, scale=TRUE, retx=TRUE)\n#summary(alltraits.pca)\n\n\n# hydrological gradient analysis\n\nhydro <- subset(hydro, gaugeID != c(\"138001A\"))\n\n\nhydro.pca <- prcomp(hydro[,4:37], retx = TRUE, center = TRUE, scale. = TRUE)\nhydro$PC1 <- hydro.pca$x[,1]\nhydro$PC2 <- hydro.pca$x[,2]\nhydro$PC3 <- hydro.pca$x[,3]\nhydro$PC4 <- hydro.pca$x[,4]\n\nhydrosites <- merge(hydro, sites, all.y=TRUE)\nhydrosites <- hydrosites[,4:41]\n\nhydrosites$FDis <- FD$FDis\nhydrosites$FDiv <- FD$FDiv\nhydrosites$FRic <- FD$FRic\nhydrosites$FEve <- FD$FEve\nhydrosites$RaoQ <- FD$RaoQ\nhydrosites$FGR <- FD$FGR\nhydrosites$nbsp <- FD$nbsp\nhydrosites$simpson <- FD.redun$Simpson\nhydrosites$FunRao <- FD.redun$FunRao\nhydrosites$redun <- FD.redun$FunRedundancy\nhydrosites$nbsp <- FD$nbsp\n\nCWM <- FD$CWM\n\nhydrosites$SLA<- CWM$SLA\nhydrosites$seed.mass <- CWM$seed.mass\nhydrosites$maximum.height <- CWM$maximum.height\nhydrosites$flowering.duration <- CWM$flowering.duration\nhydrosites$wood.density <- CWM$wood.density\nhydrosites$leaf.area <- CWM$leaf.area\n\ngetStats(hydrosites, hydrosites$FDis, FD)\ngetStats(hydrosites, hydrosites$FDiv, FD)\ngetStats(hydrosites, hydrosites$FRic, FD)\ngetStats(hydrosites, hydrosites$FEve, FD)\ngetStats(hydrosites, hydrosites$RaoQ, FD)\ngetStats(hydrosites, hydrosites$nbsp, FD)\n\n\ngetStats(hydrosites, hydrosites$simpson, FD)\ngetStats(hydrosites, hydrosites$FunRao, FD)\ngetStats(hydrosites, hydrosites$redun, FD)\n\n\n#getStats(hydrosites, hydrosites$SLA, CWM)\n#getStats(hydrosites, hydrosites$seed.mass, CWM)\n#getStats(hydrosites, hydrosites$maximum.height, CWM)\n#getStats(hydrosites, hydrosites$flowering.duration, CWM)\n#getStats(hydrosites, hydrosites$wood.density, CWM)\n#getStats(hydrosites, hydrosites$leaf.area, CWM)\n\n\n\n#plot.linear(hydrosites, hydrosites$FRic, FD)\n",
    "created" : 1431312529158.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2375779792",
    "id" : "DAF1FBB0",
    "lastKnownWriteTime" : 1431391917,
    "path" : "C:/Users/James/Desktop/stuff/data/analysis/R/SEQLD/scripts/analysis_test.R",
    "project_path" : "scripts/analysis_test.R",
    "properties" : {
        "tempName" : "Untitled5"
    },
    "source_on_save" : false,
    "type" : "r_source"
}